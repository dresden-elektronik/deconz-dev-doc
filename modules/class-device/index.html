<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  
  <link rel="shortcut icon" href="../../img/favicon.ico">
  <title>Device class - deCONZ C++ Documentation</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../../css/theme.css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css" />
  <link href="../../css/extra.css" rel="stylesheet" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "Device class";
    var mkdocs_page_input_path = "modules/class-device/index.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js" defer></script>
  <script src="../../js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> deCONZ C++ Documentation</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <p class="caption"><span class="caption-text">General</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../..">Introduction</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Modules</span></p>
                <ul class="current">
                    <li class="toctree-l1 current"><a class="reference internal current" href="./">Device class</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#overview">Overview</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#classic-c-code">Classic C++ code</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#device-code">Device code</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#state-machine">State Machine</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#high-level-view">High Level View</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#timing">Timing</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#error-handling">Error handling</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#bindings">Bindings</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#sub-devices">Sub-devices</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#testing">Testing</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#dependencies">Dependencies</a>
    </li>
    </ul>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../ddf/">Device Description Files</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../ddf-loader/">DDF Loader</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../fault-tolerance/">Fault Tolerance</a>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">deCONZ C++ Documentation</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
        
          <li>Modules &raquo;</li>
        
      
    
    <li>Device class</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/dresden-elektronik/deconz-dev-doc/edit/master/docs/modules/class-device/index.md"
          class="icon icon-github"> Edit on GitHub</a>
      
    </li>
  </ul>
  
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="device-class">Device class<a class="headerlink" href="#device-class" title="Permanent link">&para;</a></h1>
<p><mark>Work in Progress</mark></p>
<p>The Device class manages a single physical device. It controls <em>sub-devices</em> like sensors and lights soley by using their <code>Resource</code> and <code>ResourceItem</code> interface.</p>
<p>C++ sources: <a href="https://github.com/manup/deconz-rest-plugin/blob/device_descriptions/device.h">device.h</a> and  <a href="https://github.com/manup/deconz-rest-plugin/blob/device_descriptions/device.cpp">device.cpp</a></p>
<h3 id="overview">Overview<a class="headerlink" href="#overview" title="Permanent link">&para;</a></h3>
<p>The difference to classic C++ plugin code is best described by an example. The next sections show how a Philips Hue Motion Sensor is handled by classic C++ code vs. the new Device code.</p>
<h4 id="classic-c-code">Classic C++ code<a class="headerlink" href="#classic-c-code" title="Permanent link">&para;</a></h4>
<p>A Philips Hue Motion Sensor with model identifier &ldquo;SML001&rdquo; has three <code>Sensor</code> objects. </p>
<!-- inkscape -d 200 compare-dev-classic.svg  -o compare-dev-classic.png -->
<p><img alt="compare-dev-classic" src="img/compare-dev-classic.png" width="512px" /></p>
<p><strong>Pairing:</strong> The sensors are created and configured by:</p>
<pre><code class="language-cpp">addSensorNode(const deCONZ::Node *node, const deCONZ::NodeEvent *event);

addSensorNode(const deCONZ::Node *node,
              const SensorFingerprint &amp;fingerPrint,
              const QString &amp;type, const QString &amp;modelId,
              const QString &amp;manufacturer);

delayedFastEnddeviceProbe(const deCONZ::NodeEvent *event);

checkSensorBindingsForAttributeReporting(Sensor *sensor);
</code></pre>
<p><strong>Operaration:</strong> Once configured, messages from the sensor are processed in:</p>
<pre><code class="language-cpp">updateSensorNode(const deCONZ::NodeEvent &amp;event);
</code></pre>
<div class="admonition problems">
<p class="admonition-title">Problems</p>
<ul>
<li>The mentioned functions are huge, e.g. <code>updateSensorNode()</code> is over 1700 lines long</li>
<li>Some parts of the code specifically handle &ldquo;SML00&rdquo; modelid</li>
<li>There is little error handling and pairing might fail</li>
</ul>
</div>
<h4 id="device-code">Device code<a class="headerlink" href="#device-code" title="Permanent link">&para;</a></h4>
<p>The new code creates the <em>same</em> three sensors, but doesn&rsquo;t use any of the above functions.<br />
The first notable thing is a hierarchy:</p>
<p><img alt="compare-dev-classic" src="img/compare-dev-classic2.png" width="540px" /></p>
<p>The Device object acts as a controller for the sensors (sub-devices).</p>
<p><strong>Note:</strong> That <code>Sensor</code> and <code>LightNode</code> classes inherit from the <code>Resource</code> class. This makes them accessible to the <code>Device</code> class.</p>
<p><strong>Pairing:</strong> Is done by the per device <a href="#state-machine">state machine</a> which:</p>
<ul>
<li>Reads all ZDP descriptors</li>
<li>Reads ZCL Basic Cluster modelid and manufacturer name</li>
<li>Passes this data to the <a href="../ddf-loader">DDF Loader</a> class<br />
  (which creates the three sensors based on a DDF file)</li>
<li>Configures all Bindings and ZCL attribute reporting which are defined in the DDF file</li>
<li>Reads and writes ZCL attributes defined in the DDF file</li>
</ul>
<div class="admonition remarks">
<p class="admonition-title">Remarks</p>
<ul>
<li>The described steps are the same for all devices</li>
<li>The state machine handles <em>all</em> errors or faults quickly</li>
<li>The involved C++ code knows nothing about a specific device, this is all described in the DDF file. </li>
</ul>
</div>
<p>The Device class isn&rsquo;t aware about sleeping end-devices or routers, the knowledge that a device is able to receive commands comes from <em>Awake</em> and <em>Poll Events</em> which are generated by external classes and command handlers.</p>
<h2 id="state-machine">State Machine<a class="headerlink" href="#state-machine" title="Permanent link">&para;</a></h2>
<p>Each Device is driven by its own internal state machine.</p>
<p>The states are implemented as a functions that act on events. The <code>Device::handleEvent(Event)</code> method passes the events to the current state, which is internally a function pointer to one of the following state functions:</p>
<pre><code class="language-cpp">void DEV_InitStateHandler(Device *device, const Event &amp;event);
void DEV_IdleStateHandler(Device *device, const Event &amp;event);
void DEV_NodeDescriptorStateHandler(Device *device, const Event &amp;event);
void DEV_ActiveEndpointsStateHandler(Device *device, const Event &amp;event);
void DEV_SimpleDescriptorStateHandler(Device *device, const Event &amp;event);
void DEV_BasicClusterStateHandler(Device *device, const Event &amp;event);
void DEV_GetDeviceDescriptionHandler(Device *device, const Event &amp;event);
void DEV_BindingHandler(Device *device, const Event &amp;event);
void DEV_BindingTableVerifyHandler(Device *device, const Event &amp;event);
void DEV_PollIdleStateHandler(Device *device, const Event &amp;event);
void DEV_PollNextStateHandler(Device *device, const Event &amp;event);
void DEV_PollBusyStateHandler(Device *device, const Event &amp;event);
</code></pre>
<h3 id="high-level-view">High Level View<a class="headerlink" href="#high-level-view" title="Permanent link">&para;</a></h3>
<p>The following diagram shows the general flow of the state machine. Once the basic setup is done after the <em>Get DDF</em> state, the device enters the <em>Operating/Idle State</em> which runs multiple sub states in parallel.</p>
<p><img alt="Device State Machine" src="https://github.com/dresden-elektronik/deconz-rest-plugin-v2/raw/master/arch/diagrams/device_state_machine.png" /></p>
<p>If an error happens the state machine jumps back to the <em>Init State</em> and retries naturally.</p>
<!--
!!! note
    On deCONZ startup it takes 3â€“5&nbsp;milliseconds to go from *Init State* to *Operating/Idle State* for an already paired device.
-->

<p>Diagram source: <a href="https://github.com/dresden-elektronik/deconz-rest-plugin-v2/blob/master/arch/diagrams/device_state_machine.puml">device_bindings.puml</a></p>
<h3 id="timing">Timing<a class="headerlink" href="#timing" title="Permanent link">&para;</a></h3>
<p>Other than internal timeouts the timing of the state machine is controlled by events send from the DeviceTick class (see <a href="https://github.com/manup/deconz-rest-plugin/blob/device_descriptions/device_tick.h">device_tick.h</a>).</p>
<h3 id="error-handling">Error handling<a class="headerlink" href="#error-handling" title="Permanent link">&para;</a></h3>
<p>The following diagram shows how error handling for ZDP Requests is done in the <code>DEV_NodeDescriptorStateHandler()</code> state function, the same principle applies for Active Endpoints and Simple Descriptors states.</p>
<p><img alt="Node Descriptor State" src="https://github.com/dresden-elektronik/deconz-rest-plugin-v2/raw/master/arch/diagrams/device_state_node_descriptor.png" /></p>
<p>Diagram source: <a href="https://github.com/dresden-elektronik/deconz-rest-plugin-v2/blob/master/arch/diagrams/device_state_node_descriptor.puml">device_state_node_descriptor.puml</a></p>
<h3 id="bindings">Bindings<a class="headerlink" href="#bindings" title="Permanent link">&para;</a></h3>
<p>ZDP binding and ZCL reporting configuration is maintained during the full life cycle of the device by the <em>Binding</em> sub state. If any error or fault happens the state machine recovers automatically and verifies the configuration.</p>
<p>In contrast to classic REST-API C++ code the state machine also detects changes in reporting configuration and is able to apply those.</p>
<p>Each device has it&rsquo;s own copy of binding and ZCL reporting configuration which allows us later to provide custom configuration on a per device base.</p>
<p>Discussion in <a href="https://github.com/dresden-elektronik/deconz-rest-plugin-v2/issues/6">issues/6</a></p>
<p>The configuration for bindings and ZCL reporting is specified in DDF files, for example: <a href="https://github.com/manup/deconz-rest-plugin/blob/device_descriptions/devices/ikea/gu10_ws_400lm_light.json">ikea/gu10_ws_400lm_light.json</a>.</p>
<p><img alt="Binding State Machine" src="https://github.com/dresden-elektronik/deconz-rest-plugin-v2/raw/master/arch/diagrams/device_bindings.png" /></p>
<p>Diagram source: <a href="https://github.com/dresden-elektronik/deconz-rest-plugin-v2/blob/master/arch/diagrams/device_bindings.puml">device_bindings.puml</a></p>
<h2 id="sub-devices">Sub-devices<a class="headerlink" href="#sub-devices" title="Permanent link">&para;</a></h2>
<p>The <code>Device</code> class only queries ZDP descriptors and the ZCL Basic Cluster attributes modelid and manufacturer name. After that DDF files are used to create sub-devices like sensors and lights.</p>
<p>Sub-devices are created  by the <a href="../ddf-loader">DDF Loader</a>, <strong>not</strong> the <code>Device</code> class itself.</p>
<ol>
<li>
<p>When the <a href="#state-machine">Get DDF</a> state is entered the Device sends the <code>REventDDFInitRequest</code> event and waits.</p>
</li>
<li>
<p>The DDF Loader sends a <code>REventDDFInitResponse</code> event, at that time all sub device <code>Resources</code> and <code>ResourceItems</code> are initialized and the <code>Device</code> class goes into <em>Operational/Idle</em> state.</p>
</li>
</ol>
<p><img alt="Device Description File (DDF) Init" src="https://github.com/dresden-elektronik/deconz-rest-plugin-v2/raw/master/arch/diagrams/device_init_ddf.png" /></p>
<p>The <a href="https://github.com/manup/deconz-rest-plugin/blob/device_descriptions/device_compat.cpp">Device Compat</a> (compatibility) module creates empty <code>Sensor</code> and <code>LightNode</code> objects and adds them to the respective plugin <code>sensors</code> and <code>nodes</code> containers. The <a href="https://github.com/manup/deconz-rest-plugin/blob/device_descriptions/device_ddf_init.cpp">DDF Init</a> module then fills the <code>ResourceItems</code> based on the DDF file and registers the <code>Resource</code> in the <code>Device</code>.</p>
<p>This way the &ldquo;old&rdquo; code as well as the <code>Device</code> can work side by side, albeit the <code>Device</code> doesn&rsquo;t know anything about this.</p>
<p>This process can be repeated at any time, for example during development of DDF files they can be reloaded on-the-fly without restarting deCONZ.</p>
<h2 id="testing">Testing<a class="headerlink" href="#testing" title="Permanent link">&para;</a></h2>
<p>Beside loose coupling, the minimal dependencies allow easier testing of the class and its behaviour of the state machine. In general all <code>Device</code> code is kept small and has no functions longer than two screen pages (if it does it is a bug). The goal is to get close to 100% test coverage, since internally mostly free standing functions are used this becomes straight forward. Each state and sub states can be tested in isolation as well as complete sequences like device pairing.</p>
<p>First steps to test the Device class behaviour can be found in <a href="https://github.com/manup/deconz-rest-plugin/blob/device_descriptions/tests/001-device-1.cpp">001-device-1.cpp</a>.</p>
<h2 id="dependencies">Dependencies<a class="headerlink" href="#dependencies" title="Permanent link">&para;</a></h2>
<p>The class depends only on a few other classes and modules. </p>
<ul>
<li><code>Resource</code> as base class and to access sub devices</li>
<li><code>Event</code> to interact with other components and provide lose coupling</li>
<li><code>deCONZ::Node</code> to access ZDP Simple Descriptors and Node Descriptor</li>
<li><a href="https://github.com/manup/deconz-rest-plugin/blob/device_descriptions/device_access_fn.h">Device Access (DA)</a> module to execute <strong>abstract</strong> named C++ parse, read and write functions<br />
  (Examples: <a href="https://github.com/manup/deconz-rest-plugin/blob/device_descriptions/devices/ikea/kadrilj_blind.json">IKEA KADRILJ DDF</a> and <a href="https://github.com/manup/deconz-rest-plugin/blob/device_descriptions/devices/generic/items/state_on_item.json">state/on item</a>)</li>
<li><a href="https://github.com/manup/deconz-rest-plugin/blob/device_descriptions/zdp/zdp.h">ZDP</a> module to query ZDP descriptors during setup;</li>
<li><a href="https://github.com/manup/deconz-rest-plugin/blob/device_descriptions/zcl/zcl.h">ZCL</a> module to query ZCL <em>Basic Cluster</em> attributes during setup.</li>
</ul>
<p><img alt="Device Dependencies" src="https://github.com/dresden-elektronik/deconz-rest-plugin-v2/raw/master/arch/diagrams/device_dependencies.png" /></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>There are no dependencies to <code>DeRestPlugin</code>, <code>RestNodeBase</code>, <code>Sensor</code> or <code>LightNode</code> classes, even <code>deCONZ::ApsController</code> is just an opaque pointer.
All the class sees, is a device which has sub-devices as <code>Resource</code> and their <code>ResourceItems</code>.</p>
</div>
<!-- ## State Change and REST API Functionality

TODO
-->
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../ddf/" class="btn btn-neutral float-right" title="Device Description Files">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../.." class="btn btn-neutral" title="Introduction"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a href="https://github.com/dresden-elektronik/deconz-dev-doc/" class="fa fa-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span><a href="../.." style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../ddf/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
